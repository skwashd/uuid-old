<?php
// $Id$

/**
 * @file
 * Main module functions for the uuid module.
 */

// Generic Hooks

/**
 * Implements of hook_menu().
 */
function uuid_menu() {
  $items = array();

  $items['admin/config/system/uuid'] = array(
    'title' => 'Universally Unique IDentifier',
    'description' => 'Configure automatically UUID generation settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('uuid_admin'),
    'access arguments' => array('administer uuid'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'uuid.admin.inc',
  );

  return $items;
}

/**
 * Implements of hook_permissions().
 */
function uuid_permissions() {
  return array('administer uuid');
}

// Field Hooks

/**
 * Implements hook_field_info().
 */
function uuid_field_info() {
  return array(
    'uuid' => array(
      'label' => t('Universally Unique IDentifier'),
      'description' => t('Stores a Universally Unique IDentifier'),
      'default_widget' => 'hidden_value',
      'default_formatter' => 'hidden',
    ),
  );
}

/**
 * Implements hook_field_is_empty().
 */
function uuid_field_is_empty($item, $field) {
  return empty($item['uuid']);
}

/**
 * Implements hook_field_attach_presave().
 */
function uuid_field_attach_presave($entity_type, $entity) {
  // We only set the UUID for new records or new revisions
  if (empty($entity->field_uuid[LANGUAGE_NONE][0])
    || (isset($entity->revision) && $entity->revision === 1)) {
    $entity->field_uuid[LANGUAGE_NONE][0]['uuid'] = uuid_uuid();
  }
}

/**
 * Implements hook_field_widget_info_alter().
 */
function uuid_field_widget_info_alter(&$info) {
  $info['hidden_value']['field types'][] = 'uuid';
}

// Form Hacks

/**
 * Implements hook_form_alter().
 */
function uuid_form_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id) {
  $form['field']['#type'] = 'value';
  $form['field']['cardinality'] = array(
    '#type' => 'value',
    '#value' => 1,
  );
}

// UUID generators

/**
 * Fetches information about the available UUID implementations.
 */
function uuid_info() {
  return module_invoke_all('uuid_info');
}

/**
 * Implements hook_uuid_info().
 */
function uuid_uuid_info() {
  $sources = array();

  // PECL and OSSP are 2 incompatiable implementations in PHP that use the same namespace.
  if (function_exists('uuid_make')) {
    $sources['ossp'] = array(
      'callback' => 'uuid_ossp',
      'title' => t('OSSP Extension'),
    );
  }
  elseif (function_exists('uuid_create')) {
    $sources['pecl'] = array(
      'callback' => 'uuid_pecl',
      'title' => t('PECL Extension'),
    );
  }

  if (Database::getConnection()->databaseType() == 'mysql') {
    $sources['mysql'] = array(
      'callback' => 'uuid_mysql',
      'title' => t('MySQL - SELECT UUID()'),
    );
  }

  if (function_exists('com_create_guid')) {
    $sources['com'] = array(
      'callback' => 'uuid_com',
      'title' => t('Windows COM'),
    );
  }

  $sources['php'] = _uuid_uuid_php_info();

  return $sources;
}

/**
 * Fetches the PHP fallback generator config.
 *
 * This is used to keep 
 */
function _uuid_uuid_php_info() {
 return array(
    'callback' => 'uuid_php',
    'title' => t('PHP Fallback'),
  );
}

/**
 * Generates an Universally Unique IDentifier (UUID).
 *
 * @return
 *   An UUID, made up of 32 hex digits and 4 hyphens.
 */
function uuid_uuid() {
  static $callback;
  if (is_null($callback)) {
    $var_name = 'uuid_generator';
    $generator = variable_get($var_name, NULL);
    if (!is_null($generator) && isset($generators[$generator])) {
      $config = $generators[$generator];
    }
    else {
      $config = _uuid_uuid_php_info();
      variable_set($var_name, 'php');
    }

    if (isset($config['include'])) {
      drupal_load($config['include']['module'], $config['include']['filename']);
    }

    $callback = $config['callback'];
  }
  return $callback();
}

/**
 * Generates a UUID using the Windows internal GUID generator.
 *
 * See http://php.net/com_create_guid
 */
function uuid_com() {
  return trim(com_create_guid(), '{}');
}

/**
 * Generates a UUID using MySQL's implementation.
 *
 * See http://dev.mysql.com/doc/refman/5.0/en/miscellaneous-functions.html#function_uuid
 */
function uuid_mysql() {
  return db_query('SELECT UUID()')->fetchField();
}

/**
 * Generates a UUID using the (somewhat broken) OSSP PHP extension.
 *
 * See http://www.ossp.org/pkg/lib/uuid/
 */
function uuid_ossp() {
  $v4 = null;
  $out = '';

  uuid_create(&$v4);
  uuid_make($v4, UUID_MAKE_V4);
  uuid_export($v4, UUID_FMT_STR, &$out);

  return $out;
}

/**
 * Generates a UUID using the PECL extension.
 *
 * See http://pecl.php.net/package/uuid
 */
function uuid_pecl() {
  return uuid_create(UUID_TYPE_DEFAULT);
}

/**
 * Generates a UUID v4 using PHP code.
 *
 * See http://php.net/uniqid#65879
 */
function uuid_php() {
  // The field names refer to RFC 4122 section 4.1.2.
  return sprintf('%04x%04x-%04x-%03x4-%04x-%04x%04x%04x',
    // 32 bits for "time_low".
    mt_rand(0, 65535), mt_rand(0, 65535),
    // 16 bits for "time_mid".
    mt_rand(0, 65535),
    // 12 bits before the 0100 of (version) 4 for "time_hi_and_version".
    mt_rand(0, 4095),
    bindec(substr_replace(sprintf('%016b', mt_rand(0, 65535)), '01', 6, 2)),
    // 8 bits, the last two of which (positions 6 and 7) are 01, for "clk_seq_hi_res"
    // (hence, the 2nd hex digit after the 3rd hyphen can only be 1, 5, 9 or d)
    // 8 bits for "clk_seq_low" 48 bits for "node".
    mt_rand(0, 65535), mt_rand(0, 65535), mt_rand(0, 65535)
  );
}


